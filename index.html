<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sanjeev Khanal - Chartered Accountant (Semi-qualified)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700;900&display=swap" rel="stylesheet" />
  <style>
    :root {
      --background: 227 30% 10%;
      --foreground: 210 40% 98%;
      --card: 227 30% 15%;
      --card-foreground: 210 40% 98%;
      --popover: 227 30% 15%;
      --popover-foreground: 210 40% 98%;
      --primary: 210 40% 98%;
      --primary-foreground: 227 65% 33%;
      --secondary: 227 30% 20%;
      --secondary-foreground: 210 40% 98%;
      --muted: 227 30% 20%;
      --muted-foreground: 210 30% 65%;
      --accent: 262 83% 65%;
      --accent-foreground: 210 40% 98%;
      --destructive: 0 62.8% 30.6%;
      --destructive-foreground: 0 0% 98%;
      --border: 227 30% 25%;
      --input: 227 30% 25%;
      --ring: 262 83% 65%;
    }
    body {
      font-family: 'Inter', sans-serif;
      background-color: hsl(var(--background));
      color: hsl(var(--foreground));
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .workbook-active {
        background-color: white !important;
        color: #107c41 !important;
        border-top: 2px solid #107c41 !important;
        font-weight: 900 !important;
    }
    .workbook-inactive {
        background-color: #e1e1e1 !important;
        color: #64748b !important;
    }
    .workbook-inactive:hover {
        background-color: #d5d5d5 !important;
    }
    .animate-in {
        animation: enter 0.5s forwards;
    }
    .slide-in-from-right {
        animation-name: slide-in-from-right;
    }
    @keyframes enter {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    @keyframes slide-in-from-right {
        from { transform: translateX(100%); }
        to { transform: translateX(0); }
    }
  </style>
</head>
<body class="antialiased">

  <!-- Cover View -->
  <div id="cover-view" class="h-screen w-full bg-[#fcfcfc] flex flex-col items-center justify-center p-6 text-slate-800">
    <div class="max-w-2xl w-full">
      <h1 class="text-4xl font-light mb-2 tracking-tight">Sanjeev Khanal</h1>
      <p class="text-slate-400 text-sm mb-16 uppercase tracking-[0.3em]">Chartered Accountant (Semi-qualified)</p>
      <div class="space-y-8 mb-20">
        <p class="text-2xl text-slate-600 leading-relaxed font-light">
          This is not a portfolio. <br />
          This is a walkthrough of how a <span class="text-slate-900 font-medium">professional accountant</span> thinks.
        </p>
      </div>
      <button onclick="handleEnter()" class="group flex items-center space-x-4 text-base font-medium text-slate-900 border-b-2 border-slate-900 pb-2 hover:text-slate-500 hover:border-slate-300 transition-all">
        <span>Enter workbook</span>
        <i data-lucide="chevron-right" class="w-5 h-5 group-hover:translate-x-1 transition-transform"></i>
      </button>
    </div>
  </div>

  <!-- Workbook View -->
  <div id="workbook-view" class="h-screen flex-col bg-[#f3f2f1] text-[#323130] overflow-hidden font-sans" style="display: none;">
    <div class="bg-white border-b border-[#d1d1d1] flex flex-col shrink-0">
      <div class="flex items-center px-4 py-1 space-x-6 text-xs text-slate-600">
        <span class="font-semibold cursor-default">File</span>
        <span id="workbook-tab-button" class="font-semibold pb-1 cursor-pointer text-[#107c41] border-b-2 border-[#107c41]" onclick="setActiveTab('trial_dump')">Workbook</span>
        <div class="flex-grow"></div>
        <div class="flex items-center space-x-2">
          <div class="w-2 h-2 rounded-full bg-slate-900"></div>
          <span id="stage-indicator" class="text-[10px] text-slate-500 font-bold uppercase tracking-tighter">Stage 1: Ingestion</span>
        </div>
      </div>
      <div class="h-10 border-t border-[#f3f2f1] flex items-center px-4 space-x-4 bg-white">
        <div class="w-8 border-r h-full flex items-center justify-center text-slate-300 italic text-sm">fx</div>
        <div id="formula-bar" class="flex-grow text-xs font-mono text-slate-400"></div>
      </div>
    </div>

    <div class="flex-grow flex overflow-hidden">
      <div class="flex-grow overflow-auto relative bg-[#e1e1e1]">
        
        <!-- Trial Dump Tab -->
        <div id="tab-trial_dump" class="p-0 min-w-max bg-white min-h-full">
            <div id="workflow-action-0"></div>
            <div id="workflow-action-1"></div>
            <div id="workflow-action-2"></div>
            <div class="p-2 border-b text-[10px] italic text-slate-400 font-mono">
              source: ledger_extract_v2.csv | status: <span id="status-text">unreviewed</span>
            </div>
            <table id="trial-dump-table" class="w-full text-[11px] border-collapse">
              <thead>
                <tr class="bg-[#f8f9fa] text-slate-500 uppercase text-[9px]">
                  <th class="border p-1 w-8">#</th>
                  <th class="border p-1 text-left px-3 min-w-[220px]">Account Particulars</th>
                  <th colspan="2" class="border p-1 text-center bg-slate-50">Current Year (Closing)</th>
                  <th colspan="2" class="border p-1 text-center bg-slate-50">Previous Year (Closing)</th>
                  <th id="audit-header" colspan="2" class="border p-1 text-left px-3 text-slate-900" style="display: none;">Audit Classification</th>
                </tr>
                <tr class="bg-[#f8f9fa] text-slate-400 text-[8px]">
                  <th class="border p-1"></th><th class="border p-1"></th>
                  <th class="border p-1 text-right px-3">Debit</th><th class="border p-1 text-right px-3">Credit</th>
                  <th class="border p-1 text-right px-3">Debit</th><th class="border p-1 text-right px-3">Credit</th>
                  <th id="audit-group-header" class="border p-1 px-3" style="display: none;">Group</th>
                  <th id="audit-subgroup-header" class="border p-1 px-3" style="display: none;">Sub-Group</th>
                </tr>
              </thead>
              <tbody id="trial-dump-body"></tbody>
            </table>
        </div>

        <!-- Financials Tab -->
        <div id="tab-financials" class="p-12 max-w-4xl mx-auto bg-white min-h-full shadow-lg mb-20" style="display: none;">
          <header class="mb-12 border-b-8 border-slate-900 pb-4">
            <h1 class="text-3xl font-black uppercase tracking-tighter">Audited Financial Statements</h1>
            <p class="text-xs text-slate-400 mt-2">Comparative Reporting Cycle | Indirect Method Cash Flow</p>
          </header>
          <div id="financials-tables"></div>
          <footer class="mt-20 border-t pt-6 text-[10px] text-slate-400 italic text-right flex justify-between items-center">
            <span>Verification ID: #SX-2025-CF-09</span>
            <span>Financial statements describe a business. They do not explain it.</span>
          </footer>
          <div class="flex justify-center mt-12 pb-12">
            <button onclick="setActiveTab('analysis'); setStage(5);" class="text-xs text-slate-500 flex items-center space-x-2 group hover:text-slate-900 transition-all">
              <span class="border-b border-transparent group-hover:border-slate-900 uppercase font-bold tracking-tighter">view ratio analysis</span>
              <i data-lucide="chevron-right" class="w-3 h-3 translate-y-0.5"></i>
            </button>
          </div>
        </div>

        <!-- Analysis Tab -->
        <div id="tab-analysis" class="p-12 max-w-5xl mx-auto min-h-full space-y-10" style="display: none;">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-white border-2 border-slate-200 p-8 shadow-sm hover:border-slate-900 transition-all group">
                <div class="text-[10px] font-black text-slate-900 uppercase mb-4 tracking-widest border-b border-slate-900 inline-block pb-1">Liquidity</div>
                <div class="text-4xl font-light text-slate-900 mb-1 group-hover:scale-105 transition-transform origin-left">2.27</div>
                <div class="text-xs font-bold text-slate-500 mb-6">Current Ratio</div>
                <p class="text-[10px] leading-relaxed text-slate-400 italic font-medium">Target Benchmark: 1.50x - 2.00x</p>
            </div>
            <div class="bg-white border-2 border-slate-200 p-8 shadow-sm hover:border-slate-900 transition-all group">
                <div class="text-[10px] font-black text-slate-900 uppercase mb-4 tracking-widest border-b border-slate-900 inline-block pb-1">Profitability</div>
                <div class="text-4xl font-light text-slate-900 mb-1 group-hover:scale-105 transition-transform origin-left">35.1%</div>
                <div class="text-xs font-bold text-slate-500 mb-6">GP Margin</div>
                <p class="text-[10px] leading-relaxed text-slate-400 italic font-medium">Core operational surplus</p>
            </div>
            <div class="bg-white border-2 border-slate-200 p-8 shadow-sm hover:border-slate-900 transition-all group">
                <div class="text-[10px] font-black text-slate-900 uppercase mb-4 tracking-widest border-b border-slate-900 inline-block pb-1">Solvency</div>
                <div class="text-4xl font-light text-slate-900 mb-1 group-hover:scale-105 transition-transform origin-left">0.52</div>
                <div class="text-xs font-bold text-slate-500 mb-6">Debt/Equity</div>
                <p class="text-[10px] leading-relaxed text-slate-400 italic font-medium">Capital structure health</p>
            </div>
          </div>
          <div class="bg-white border-2 border-slate-900 p-10 shadow-sm relative overflow-hidden group">
            <h3 class="text-xs font-bold uppercase text-slate-400 tracking-widest flex items-center mb-8 relative">
              <i data-lucide="trending-up" class="w-4 h-4 mr-2 text-slate-900"></i> Efficiency Cycle Insights
            </h3>
            <div class="grid grid-cols-2 gap-16 relative">
              <div>
                <div class="text-4xl font-light text-slate-900">122 <span class="text-sm font-medium text-slate-400">Days</span></div>
                <div class="text-[10px] text-slate-500 uppercase mt-2 tracking-tighter">Inventory Holding (Stock velocity)</div>
              </div>
              <div>
                <div class="text-4xl font-light text-slate-900">35 <span class="text-sm font-medium text-slate-400">Days</span></div>
                <div class="text-[10px] text-slate-500 uppercase mt-2 tracking-tighter">Debtor Collection (Receivable cycle)</div>
              </div>
            </div>
          </div>
          <div class="flex justify-center mt-12">
            <button onclick="setActiveTab('professional_insights'); setStage(6);" class="text-xs text-slate-500 flex items-center space-x-2 group hover:text-slate-900">
              <span class="border-b border-transparent group-hover:border-slate-900 uppercase font-bold tracking-tighter">view professional insights</span>
              <i data-lucide="chevron-right" class="w-3 h-3 translate-y-0.5"></i>
            </button>
          </div>
        </div>

        <!-- Professional Insights Tab -->
        <div id="tab-professional_insights" class="p-12 max-w-5xl mx-auto min-h-full pb-32 space-y-8" style="display: none;">
           <div class="bg-slate-900 text-white p-12 space-y-4 shadow-2xl relative">
              <h3 class="text-[10px] font-bold uppercase text-slate-500 tracking-[0.2em]">Audit Summary & Synthesis</h3>
              <p class="text-2xl font-light leading-relaxed max-w-2xl relative z-10">
                The <span class="text-white border-b border-slate-500 font-medium">Indirect Cash Flow reconciliation</span> indicates a robust conversion of Profit Before Tax to Operating Cash, though significant dividends suggest a capital-heavy distribution phase.
              </p>
           </div>
           <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white border-l-8 border-slate-900 p-8 shadow-sm space-y-4 hover:shadow-md transition-shadow group">
                    <div class="flex items-center space-x-3 text-slate-900 text-xs font-black uppercase tracking-widest group-hover:translate-x-1 transition-transform">
                    <i data-lucide="arrow-up-right" class="w-4 h-4"></i> <span>Revenue Quality</span>
                    </div>
                    <p class="text-sm leading-relaxed text-slate-600 font-light italic">
                    Growth of 18.4% YoY is supported by a healthy 35.1% GP margin. However, the rise in Trade Receivables (30% increase) outpaces revenue growth, suggesting a potential relaxation in credit terms or collection friction.
                    </p>
                </div>
                <div class="bg-white border-l-8 border-slate-900 p-8 shadow-sm space-y-4 hover:shadow-md transition-shadow group">
                    <div class="flex items-center space-x-3 text-slate-900 text-xs font-black uppercase tracking-widest group-hover:translate-x-1 transition-transform">
                        <i data-lucide="zap" class="w-4 h-4"></i> <span>Working Capital Drag</span>
                    </div>
                    <p class="text-sm leading-relaxed text-slate-600 font-light italic">
                        Inventory holding at 122 days represents a significant liquidity lock-up. This "Inventory Trap" is the primary reason why net cash increase (170k) is substantially lower than net profit (2.05M).
                    </p>
                </div>
                <div class="bg-white border-l-8 border-slate-900 p-8 shadow-sm space-y-4 hover:shadow-md transition-shadow group">
                    <div class="flex items-center space-x-3 text-slate-900 text-xs font-black uppercase tracking-widest group-hover:translate-x-1 transition-transform">
                        <i data-lucide="shield-check" class="w-4 h-4"></i> <span>Capital Structure</span>
                    </div>
                    <p class="text-sm leading-relaxed text-slate-600 font-light italic">
                        Debt-to-Equity remains conservative at 0.52. The reduction in Secured Loans (-300k) alongside healthy interest coverage indicates strong solvency and low financial risk.
                    </p>
                </div>
                <div class="bg-white border-l-8 border-slate-900 p-8 shadow-sm space-y-4 hover:shadow-md transition-shadow group">
                    <div class="flex items-center space-x-3 text-slate-900 text-xs font-black uppercase tracking-widest group-hover:translate-x-1 transition-transform">
                        <i data-lucide="bar-chart-3" class="w-4 h-4"></i> <span>Cash Flow Quality</span>
                    </div>
                    <p class="text-sm leading-relaxed text-slate-600 font-light italic">
                        Cash conversion cycle is currently 122 + 35 - 70 (estimated) = 87 days. The reliance on Trade Payables to fund inventory (Increase of 440k) is a short-term strategy that may hit limits.
                    </p>
                </div>
                <div class="bg-white border-l-8 border-slate-900 p-8 shadow-sm space-y-4 hover:shadow-md transition-shadow group">
                    <div class="flex items-center space-x-3 text-slate-900 text-xs font-black uppercase tracking-widest group-hover:translate-x-1 transition-transform">
                        <i data-lucide="alert-circle" class="w-4 h-4"></i> <span>Tax & Compliance</span>
                    </div>
                    <p class="text-sm leading-relaxed text-slate-600 font-light italic">
                        Effective tax rate is aligned at 30%. Non-cash add-backs (Depreciation & Finance costs) provide a 840k buffer to operating cash flow, acting as a natural internal hedge against inflation.
                    </p>
                </div>
                <div class="bg-white border-l-8 border-slate-900 p-8 shadow-sm space-y-4 hover:shadow-md transition-shadow group">
                    <div class="flex items-center space-x-3 text-slate-900 text-xs font-black uppercase tracking-widest group-hover:translate-x-1 transition-transform">
                        <i data-lucide="pie-chart" class="w-4 h-4"></i> <span>Strategic Outlook</span>
                    </div>
                    <p class="text-sm leading-relaxed text-slate-600 font-light italic">
                        The high dividend payout (approx. 95% of net profit) suggests the entity is in a 'Mature/Cash Cow' phase, opting for shareholder returns over aggressive reinvestment in PPE.
                    </p>
                </div>
           </div>
           <div class="pt-16 text-center border-t border-slate-200">
              <p class="text-sm italic text-slate-400 mb-10 max-w-lg mx-auto">"A Balance Sheet is a snapshot; the Cash Flow is the movie. Integrity lies in ensuring they tell the same story."</p>
              <div class="flex justify-center space-x-6">
                <button class="px-8 py-3 bg-slate-900 text-white text-[10px] font-bold uppercase tracking-widest hover:bg-slate-700 transition-all shadow-lg">Download CV</button>
                <button class="px-8 py-3 border-2 border-slate-900 text-slate-900 text-[10px] font-bold uppercase tracking-widest hover:bg-slate-50 transition-all">Contact Me</button>
              </div>
           </div>
        </div>
      </div>

      <div id="insight-panel" class="w-72 bg-white border-l p-8 shrink-0 hidden lg:block" style="display: none;">
        <h4 class="text-[10px] font-black uppercase text-slate-300 mb-8 tracking-[0.3em]">Context</h4>
        <p id="insight-text" class="text-xs leading-relaxed text-slate-500 font-light italic"></p>
      </div>
    </div>

    <div class="bg-[#f3f2f1] border-t border-[#d1d1d1] flex items-center px-2 py-0.5 text-[10px] shrink-0 font-medium">
      <div class="flex space-x-0.5">
        <button id="sheet-tab-trial_dump" onclick="setActiveTab('trial_dump')" class="px-6 py-1.5 border-r border-[#d1d1d1] transition-all min-w-[120px] uppercase tracking-tighter text-center workbook-active">trial dump</button>
        <button id="sheet-tab-financials" onclick="setActiveTab('financials')" class="px-6 py-1.5 border-r border-[#d1d1d1] transition-all min-w-[120px] uppercase tracking-tighter text-center workbook-inactive opacity-30 cursor-not-allowed" disabled>financials</button>
        <button id="sheet-tab-analysis" onclick="setActiveTab('analysis')" class="px-6 py-1.5 border-r border-[#d1d1d1] transition-all min-w-[120px] uppercase tracking-tighter text-center workbook-inactive opacity-30 cursor-not-allowed" disabled>analysis</button>
        <button id="sheet-tab-professional_insights" onclick="setActiveTab('professional_insights')" class="px-6 py-1.5 border-r border-[#d1d1d1] transition-all min-w-[120px] uppercase tracking-tighter text-center workbook-inactive opacity-30 cursor-not-allowed" disabled>professional insights</button>
      </div>
    </div>
  </div>

  <script>
    lucide.createIcons();

    const data = {
        trialDump: [
            { particulars: "Revenue from Operations", cy_dr: "", cy_cr: 14800000, py_dr: "", py_cr: 12500000, group: "Income", sub: "Revenue" },
            { particulars: "Cost of Goods Sold", cy_dr: 9600000, cy_cr: "", py_dr: 8200000, py_cr: "", group: "Expense", sub: "COS" },
            { particulars: "Employee Benefits", cy_dr: 1420000, cy_cr: "", py_dr: 1200000, py_cr: "", group: "Expense", sub: "Admin" },
            { particulars: "Depreciation & Amortization", cy_dr: 520000, cy_cr: "", py_dr: 480000, py_cr: "", group: "Expense", sub: "Non-Cash" },
            { particulars: "Finance Costs", cy_dr: 320000, cy_cr: "", py_dr: 280000, py_cr: "", group: "Expense", sub: "Finance" },
            { particulars: "Property, Plant & Equipment", cy_dr: 8450000, cy_cr: "", py_dr: 8450000, py_cr: "", group: "Asset", sub: "Non-Current" },
            { particulars: "Inventory", cy_dr: 2100000, cy_cr: "", py_dr: 1850000, py_cr: "", group: "Asset", sub: "Current" },
            { particulars: "Trade Receivables", cy_dr: 1430000, cy_cr: "", py_dr: 1100000, py_cr: "", group: "Asset", sub: "Current" },
            { particulars: "Cash & Bank", cy_dr: 630000, cy_cr: "", py_dr: 460000, py_cr: "", group: "Asset", sub: "Current" },
            { particulars: "Share Capital", cy_dr: "", cy_cr: 5000000, py_dr: "", py_cr: 5000000, group: "Equity", sub: "Capital" },
            { particulars: "Retained Earnings", cy_dr: "", cy_cr: 3270000, py_dr: "", py_cr: 2660000, group: "Equity", sub: "Reserves" },
            { particulars: "Secured Loans", cy_dr: "", cy_cr: 2500000, py_dr: "", py_cr: 2800000, group: "Liability", sub: "Non-Current" },
            { particulars: "Trade Payables", cy_dr: "", cy_cr: 1840000, py_dr: "", py_cr: 1400000, group: "Liability", sub: "Current" }
        ],
        financials: {
            SOPL: [ { label: "Revenue from Operations", cy: 14800000, py: 12500000 }, { label: "Cost of Goods Sold", cy: -9600000, py: -8200000 }, { label: "Gross Profit", cy: 5200000, py: 4300000, bold: true }, { label: "Employee Benefits", cy: -1420000, py: -1200000 }, { label: "Depreciation & Amortization", cy: -520000, py: -480000 }, { label: "Finance Costs", cy: -320000, py: -280000 }, { label: "Profit Before Tax", cy: 2940000, py: 2340000, bold: true }, { label: "Tax Expense (30%)", cy: -882000, py: -702000 }, { label: "Net Profit for the Year", cy: 2058000, py: 1638000, bold: true } ],
            SOFP: [ { label: "Property, Plant & Equipment", cy: 8450000, py: 8450000 }, { label: "Inventory", cy: 2100000, py: 1850000 }, { label: "Trade Receivables", cy: 1430000, py: 1100000 }, { label: "Cash & Bank", cy: 630000, py: 460000 }, { label: "Total Assets", cy: 12610000, py: 11860000, bold: true }, { label: "Share Capital", cy: 5000000, py: 5000000 }, { label: "Retained Earnings", cy: 3270000, py: 2660000 }, { label: "Total Equity", cy: 8270000, py: 7660000, bold: true }, { label: "Secured Loans", cy: 2500000, py: 2800000 }, { label: "Trade Payables", cy: 1840000, py: 1400000 }, { label: "Total Liabilities", cy: 4340000, py: 4200000, bold: true }, { label: "Total Equity & Liabilities", cy: 12610000, py: 11860000, bold: true } ],
            SOCF: [ { label: "Profit Before Tax", cy: 2940000, py: 2340000, bold: true }, { label: "Adjustments for Non-Cash Items:", cy: null, py: null, italic: true }, { label: "Add: Depreciation & Amortization", cy: 520000, py: 480000 }, { label: "Add: Finance Costs", cy: 320000, py: 280000 }, { label: "Operating Profit before Working Capital Changes", cy: 3780000, py: 3100000, bold: true }, { label: "Changes in Working Capital:", cy: null, py: null, italic: true }, { label: "(Increase)/Decrease in Inventory", cy: -250000, py: -200000 }, { label: "(Increase)/Decrease in Trade Receivables", cy: -330000, py: -300000 }, { label: "Increase/(Decrease) in Trade Payables", cy: 440000, py: 300000 }, { label: "Cash Generated from Operations", cy: 3640000, py: 2900000 }, { label: "Less: Income Tax Paid", cy: -882000, py: -702000 }, { label: "Net Cash Flow from Operating Activities (A)", cy: 2758000, py: 2198000, bold: true }, { label: "Net Cash Flow from Investing Activities (B)", cy: 0, py: 0, bold: true }, { label: "Cash Flow from Financing Activities:", cy: null, py: null, italic: true }, { label: "Repayment of Secured Loans", cy: -300000, py: -300000 }, { label: "Interest Paid", cy: -320000, py: -280000 }, { label: "Dividends Paid / Adjustments", cy: -1968000, py: -1438000 }, { label: "Net Cash Flow from Financing Activities (C)", cy: -2588000, py: -2018000, bold: true }, { label: "Net Increase/(Decrease) in Cash (A+B+C)", cy: 170000, py: 180000, bold: true }, { label: "Add: Opening Cash & Bank Balance", cy: 460000, py: 280000 }, { label: "Closing Cash & Bank Balance", cy: 630000, py: 460000, bold: true } ]
        }
    };

    let activeTab = 'trial_dump';
    let stage = 1;
    let workflowStep = 0;
    let showInsight = false;

    const formatValue = (num) => {
        if (num === undefined || num === null) return "-";
        const abs = Math.abs(num);
        const formatted = abs.toLocaleString();
        return num < 0 ? `(${formatted})` : formatted;
    };

    const formatNum = (val, step) => {
        if (val === "" || val === undefined) return "";
        if (step === 0) return val;
        return Number(val).toLocaleString();
    };

    const getStageName = (s) => ['', 'Ingestion', 'Integrity', 'Structure', 'Presentation', 'Analytical Review', 'Opinion'][s];
    
    const getInsightText = (s) => {
        switch(s) {
            case 2: return "Reconciling profit to cash flow is where 'accounting profit' meets 'economic reality'.";
            case 4: return "The indirect method allows us to identify why cash didn't grow as fast as profits (Working Capital traps).";
            default: return "Verification of the opening/closing cash balances ensures the entire ledger is mathematically sound.";
        }
    };

    function updateUI() {
        // Update stage indicator
        document.getElementById('stage-indicator').textContent = `Stage ${stage}: ${getStageName(stage)}`;
        
        // Update formula bar
        const formulaBar = document.getElementById('formula-bar');
        if (activeTab === 'analysis') {
            formulaBar.textContent = `=ROUND(Current_Assets/Current_Liabilities, 2)`;
        } else if (activeTab === 'financials') {
            formulaBar.textContent = `=SUM(Operating, Investing, Financing)`;
        } else {
            formulaBar.textContent = "";
        }

        // Show/hide tabs
        ['trial_dump', 'financials', 'analysis', 'professional_insights'].forEach(tabId => {
            document.getElementById(`tab-${tabId}`).style.display = (activeTab === tabId) ? 'block' : 'none';
        });

        // Update sheet tab styles
        ['trial_dump', 'financials', 'analysis', 'professional_insights'].forEach(tabId => {
            const button = document.getElementById(`sheet-tab-${tabId}`);
            if (activeTab === tabId) {
                button.classList.add('workbook-active');
                button.classList.remove('workbook-inactive');
            } else {
                button.classList.remove('workbook-active');
                button.classList.add('workbook-inactive');
            }
        });
        
        // Update workflow actions
        document.getElementById('workflow-action-0').innerHTML = workflowStep === 0 ? createWorkflowAction('handleClean', 'wand-2', 'clean data', null, 'Raw ledgers are often noisy. Cleaning removes duplicates and corrects inconsistencies, ensuring we aren\'t building a report on a broken foundation.') : '';
        document.getElementById('workflow-action-1').innerHTML = workflowStep === 1 ? createWorkflowAction('handleStandardize', 'layout-grid', 'standardize data', null, 'Different businesses use different names for the same thing. Standardization maps unique account heads to universal audit categories for consistency.') : '';
        document.getElementById('workflow-action-2').innerHTML = workflowStep === 2 ? createWorkflowAction('handlePrepare', 'check-circle-2', 'prepare fs', 'generate audited financials', 'This is the final transformationâ€”aggregating verified entries into the Statement of Financial Position and Profit & Loss, ready for stakeholder review.') : '';
        
        // Update trial dump table
        const trialDumpBody = document.getElementById('trial-dump-body');
        let tableHTML = '';
        data.trialDump.forEach((row, i) => {
            tableHTML += `
                <tr class="hover:bg-slate-50 border-b">
                    <td class="border text-center bg-[#f8f9fa] text-slate-400 px-1">${i + 1}</td>
                    <td class="border px-3 py-1.5 ${workflowStep >= 1 ? 'capitalize' : 'lowercase font-mono text-slate-400'}">${row.particulars}</td>
                    <td class="border px-3 py-1 text-right font-mono text-slate-900">${formatNum(row.cy_dr, workflowStep)}</td>
                    <td class="border px-3 py-1 text-right font-mono text-slate-900">${formatNum(row.cy_cr, workflowStep)}</td>
                    <td class="border px-3 py-1 text-right font-mono text-slate-500">${formatNum(row.py_dr, workflowStep)}</td>
                    <td class="border px-3 py-1 text-right font-mono text-slate-500">${formatNum(row.py_cr, workflowStep)}</td>
            `;
            if (workflowStep >= 2) {
                tableHTML += `
                    <td class="border px-3 py-1 text-slate-900 font-semibold">${row.group}</td>
                    <td class="border px-3 py-1 text-slate-600 italic">${row.sub}</td>
                `;
            }
             tableHTML += `</tr>`;
        });
        trialDumpBody.innerHTML = tableHTML;


        if (workflowStep >= 2) {
            document.getElementById('audit-header').style.display = '';
            document.getElementById('audit-group-header').style.display = '';
            document.getElementById('audit-subgroup-header').style.display = '';
        } else {
             document.getElementById('audit-header').style.display = 'none';
             document.getElementById('audit-group-header').style.display = 'none';
             document.getElementById('audit-subgroup-header').style.display = 'none';
        }
        
        document.getElementById('status-text').textContent = workflowStep >= 2 ? 'verified' : 'unreviewed';

        // Enable/disable tabs based on workflow
        if (workflowStep >= 3) {
            ['financials', 'analysis', 'professional_insights'].forEach(tabId => {
                const button = document.getElementById(`sheet-tab-${tabId}`);
                button.disabled = false;
                button.classList.remove('opacity-30', 'cursor-not-allowed');
            });
        }

        // Insight panel
        const insightPanel = document.getElementById('insight-panel');
        if (showInsight) {
            insightPanel.style.display = 'block';
            insightPanel.classList.add('animate-in', 'slide-in-from-right');
            document.getElementById('insight-text').textContent = getInsightText(stage);
        } else {
            insightPanel.style.display = 'none';
        }

        lucide.createIcons();
    }

    function createWorkflowAction(onClickFn, icon, text, sub, tooltip) {
        return `
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-50 flex flex-col items-center group">
            <button 
            onclick="${onClickFn}()" 
            class="bg-white border-2 border-slate-900 shadow-[20px_20px_0px_rgba(0,0,0,0.05)] px-10 py-6 flex flex-col items-center space-y-3 hover:bg-slate-50 transition-all rounded-sm"
            >
            <div class="flex items-center space-x-4 text-slate-900 group-hover:scale-105 transition-transform">
                <i data-lucide="${icon}" class="w-4 h-4"></i> <span class="text-sm font-black uppercase tracking-widest">${text}</span>
            </div>
            ${sub ? `<span class="text-[10px] text-slate-400 font-medium lowercase tracking-tight">${sub}</span>` : ''}
            </button>
            <div class="mt-4 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none max-w-xs text-center bg-slate-900 text-white p-4 text-[11px] leading-relaxed rounded-md shadow-2xl relative">
                <p class="font-light italic text-slate-300">${tooltip}</p>
                <div class="absolute -top-1 left-1/2 -translate-x-1/2 w-2 h-2 bg-slate-900 rotate-45"></div>
            </div>
        </div>
        `;
    }
    
    function createFinancialTable(title, rows) {
        const rowsHtml = rows.map(r => `
            <tr class="border-b border-slate-50 hover:bg-slate-50/50 transition-colors ${r.bold ? 'font-bold border-t border-slate-400' : ''} ${r.italic ? 'italic text-slate-400 bg-slate-50/20' : ''}">
                <td class="py-3 pr-4 ${r.bold ? 'text-slate-900' : 'text-slate-600'} ${r.italic ? 'pl-2' : ''}">${r.label}</td>
                <td class="text-right py-3 font-mono ${r.bold ? 'text-slate-900' : 'text-slate-800'}">${r.cy !== null ? formatValue(r.cy) : ''}</td>
                <td class="text-right py-3 font-mono text-slate-400">${r.py !== null ? formatValue(r.py) : ''}</td>
            </tr>
        `).join('');

        return `
            <section class="mb-14">
                <h2 class="text-[10px] font-black bg-slate-900 text-white px-3 py-1 mb-4 inline-block uppercase tracking-[0.2em]">${title}</h2>
                <table class="w-full text-sm">
                <thead>
                    <tr class="text-[9px] text-slate-400 uppercase text-right border-b">
                    <th class="text-left font-bold pb-2 text-slate-500">Particulars</th>
                    <th class="pb-2">Current Year</th>
                    <th class="pb-2">Previous Year</th>
                    </tr>
                </thead>
                <tbody>${rowsHtml}</tbody>
                </table>
            </section>
        `;
    }

    function handleEnter() {
        document.getElementById('cover-view').style.display = 'none';
        document.getElementById('workbook-view').style.display = 'flex';
        updateUI();
    }

    function setActiveTab(tab) {
        if(document.getElementById(`sheet-tab-${tab}`).disabled) return;
        activeTab = tab;
        updateUI();
    }
    
    function setStage(newStage) {
        stage = newStage;
        updateUI();
    }

    function handleClean() {
        workflowStep = 1;
        stage = 2;
        showInsight = true;
        updateUI();
    }

    function handleStandardize() {
        workflowStep = 2;
        stage = 3;
        updateUI();
    }
    
    function handlePrepare() {
        workflowStep = 3;
        setTimeout(() => {
            stage = 4;
            setActiveTab('financials');
        }, 800);
        updateUI();
    }

    document.addEventListener('DOMContentLoaded', (event) => {
        const financialsContainer = document.getElementById('financials-tables');
        financialsContainer.innerHTML += createFinancialTable("Statement of Profit and Loss", data.financials.SOPL);
        financialsContainer.innerHTML += createFinancialTable("Statement of Financial Position", data.financials.SOFP);
        financialsContainer.innerHTML += createFinancialTable("Statement of Cash Flows (Indirect Method)", data.financials.SOCF);

        updateUI();
    });
  </script>
</body>
</html>
